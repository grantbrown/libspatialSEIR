\documentclass[12pt]{article}
\oddsidemargin .15in \evensidemargin .0in \topmargin 0in
\columnsep 10pt \columnseprule 0pt
\marginparwidth 19pt \marginparsep 11pt \marginparpush 5pt
\headheight 0pt \headsep 0pt
\textheight 8in
\textwidth 6in 
\pagestyle{plain}
\usepackage{graphicx, latexsym}
\usepackage{alltt}
\usepackage{float}
\usepackage{amsmath}

\newcommand \noi {\noindent}
\newcommand \itx {\indent \indent \indent}
\newcommand \bg {\begin}
\newcommand \en {\end}
\newcommand \mth {\begin{math}}
\newcommand \mthx {\end{math}}
\newcommand \ds {\displaystyle}
\newcommand \mbreak {\\ \vspace{0.1in}}
\begin{document}

\begin{center}    
    \noi \bf libspatialSEIR: Model, Algorithm, and Implementation\\
    \vspace{.05in}
    \noi Summer 2014\\
    \vspace{.05in}

    \vspace{.15in}
    \noi Grant Brown\\ 

\end{center}
\section{The SEIR Compartmental Epidemic Model}
\subsection{Introduction}
Compartmental epidemic modeling is a flexible and extensible method of describing epidemic behavior.  
Such techniques rely on the idea that individuals within a population undergoing an epidemic process 
can be categorized by disease state. The most common terms used to describe these disease states are: \\ 

\begin{itemize}
    \item {\bf{Susceptible}}: Individuals capable of contracting the disease of interest. 
    \item {\bf{Exposed}}: Individuals who have contracted the disease, but are not yet infectious. 
    \item {\bf{Infectious}}: Individuals who are capable of spreading the disease.  
    \item {\bf{Recovered/Removed}}: Individuals who have either recovered or been removed from the population. 
\end{itemize}

Persons in a population are assumed to move through these disease categories sequentially according to the 
disease process, though in practice these disease states are combined in different ways. For example, a simple epidemic model
might use an S-I-R structure in which individuals become immediately infectious (ie, there is no latent period), and 
are subsequently removed from the population (ie, assuming permanent immunity). For a disease which conferrs only 
temporary immunity, such as influenza, many
researchers have employed S-I-R-S models, which include a potential for previously recovered individuals to be reintroduced
to the susceptible population. Similarly, SEIR and SEIRS models introduce a latent period during which exposed individuals
are not yet, but will become, infectious. In cases where the reintroduction process is either complicated, or data is sparse, 
researchers can employ a "Serial SEIR" model, which simply re-sets the susceptible population at regular intervals.\\ 

This diverse family temporal structures has been generalized to allow epidemics to be modeled over space, as well as time.  

\subsection{TL;DR - What is libsaptialSEIR for?}

libspatialSEIR was designed to provide a computationally efficient and user friendly method to fit several important epidemic 
models in the Bayesian spatial SEIRS family. In particular, spatial and single location models are allowed to evolve through 
time via one of several SEIRS-like structures, with a particular effort to allow the inclusion of linear predictors to drive
important model parameters. Notable examples include:

\begin{itemize}
    \item Single location SEIR and SEIRS models.   
    \item Spatial SEIR and SEIRS models, employing a user specified measure of distance between spatial locations. 
    \item Serial SEIR models, both for single locations and spatially indexed data. 
\end{itemize}

The focus on linear predictors provides an additional layer of flexibility to these models, as they can accommodate 
temporal basis functions for epidemic shape fitting, intervention indicators for public health efforts, demographic 
effects on population mixing, and anything else that can be expressed as a linear combination of unknown, normally
distributed parameters.\\ 


Example code for each of these models is included in the \textit{scripts} directory.

{\bf{to do: Make a knitr walkthrough of one of the more interesting models (Google flu?)}}


\subsection{SEIRS Model Family - Formal Development}
        Developed below is the most general member of the SEIRS family which can be fit with libspatialSEIR, 
        namely the spatial SEIRS model. Important special cases are discussed in \{ \textit{{\bf{to do:}} Add discussion of special cases.} \}

    \subsubsection{Compartments and Notation}
        Denote the spatial locations of interest $\left\{s_i : i = 1, ...,n \right\}$ \mbreak
        Let $d(s_i, s_l) = d_{il}$ define a measure of distance between 
        spatial locations. Note that $s_i$ and $s_l$. $d(s_i, s_i) = 0$, and $d(s_i, s_l) = d(s_l, s_i)$ \mbreak
        Let time (in units appropriate to the data and disease process) be denoted ${t_j : j = 1, ...,T}$ \mbreak
        Define the following components for each $s_i$ and $t_j$: \mbreak

        \begin{itemize}
            \item {$\bf{N_{ij}}$} is the population size
            \item {$\bf{S_{ij}}$} is the count of susceptible individuals
            \item {$\bf{E_{ij}}$} is the count of exposed individuals
            \item {$\bf{I_{ij}}$} is the count of infectious individuals
            \item {$\bf{R_{ij}}$} is the count of recovered/removed individuals
            \item {$\bf{S^*_{ij}}$} is the number of newly susceptible individuals
            \item {$\bf{E^*_{ij}}$} is the number of newly exposed individuals
            \item {$\bf{I^*_{ij}}$} is the number of newly infectious individuals
            \item {$\bf{R^*_{ij}}$} is the number of newly recovered/removed individuals
        \end{itemize}
        Let {$\bf{N_j} = \bf{S_j + E_j + I_j + R_j}$} for all $j$\\
        In addition let ${\bf{S_0, E_0, I_0,}}$ and ${\bf{R_0}}$ denote the $n$-vectors of unknown compartment sizes at the 
        start of the modeling period. 
        

    \subsubsection{Disease Evolution Process Model}
    Given the values of the aforementioned parameters, the disease process evolves forward in time 
    as one would expect based on the definitions.  
    \begin{center}
        $\bf{S_{j+1}} = \bf{S_j} - \bf{E_j^*} + \bf{S_j^*}$\mbreak
        $\bf{E_{j+1}} = \bf{E_j} - \bf{I_j^*} + \bf{E_j^*}$\mbreak
        $\bf{I_{j+1}} = \bf{I_j} - \bf{R_j^*} + \bf{I_j^*}$\mbreak
        $\bf{R_{j+1}} = \bf{R_j} - \bf{S_j^*} + \bf{R_j^*}$\mbreak
    \end{center}
    \vspace{0.15in}

    While models of this form are often fit using deterministic systems of differential equations, libspatialSEIR uses
    a heirarchical Bayesian framework in order to adequately capture the inherent variability in the model parameters.
    Thus, we begin by specifying the following likelihood components:\\

    \vspace{0.15in}

        \noi

        $\{S_{ij}^* | \pi_j^{(RS)}, R_{ij}\} \sim\ (indep.)\  binom(R_{ij}, \pi_j^{(RS)})$\mbreak

        $\{E_{ij}^* | \pi^{(SE)}_{ij}, S_{ij} \} \sim (indep.)\ binom(S_{ij}, \pi^{SE}_{ij})$ \mbreak

        $\{I_{ij}^* | \pi^{(EI)}, E_{ij} \} \sim\ (indep.)\ binom(E_{ij}, \pi^{(EI)})$\mbreak

        $\{R_{ij}^* | \pi^{(IR)}, I_{ij}\} \sim\ (indep.)\ binom(I_{ij}, \pi^{(IR)})$\mbreak


        Moving on to the next level of the model, we must specify distribution for the probability terms. $\pi^{EI}$, and $\pi^{IR}$ are easily modeled with standard prior distributions (indeed, beta prior distributions are both flexible and conjugate to the binomial likelihood).  
More care must be given to the development of a model for the $\left\{\pi^{SE}_{ij} \right\}$ and $\left\{\pi^{RS}_j \right\}$. The first of
these describes the actual infection process and must account for predictor variables as well as the 
spatial structure of $\left\{ s_i \right\}$. The second drives the reinfection process, which captures the effects of diminishing temporary immunity, 
disease strain mutation, and the introduction of new infectious agents. These important components are examined in the following sections. 


\subsection{Infection Process - CAR Model Motivation}

Consider the process by which people become infected with a communicable disease. 
Namely, consider the situation in which a person `A' has contacted another person, `B', 
who is infectious (for some suitable definition of contacted). 
Let $p$ be the probability that person `A' becomes infected with the disease, and
let $q=1-p$. Now we introduce a number of assumptions:

\begin{itemize}

    \item Assume that the number of `contacts' $K_i$ between a person of interest 
    and other individuals within a spatial unit $s_i$ at a given time point follows a poisson 
    distribution:\\
    \begin{center}
        $K_j \sim Po(\lambda_i)$
    \end{center}
    \item Assume that when individuals travel to other spatial locations, their 
        contact behavior is well modeled by the contact behavior of that spatial unit (when in Rome).  
    \item Contact between spatial locations is proportional to some known function $f(d_{il})$
        of the chosen distance metric between the centroids of $s_i$ and $s_l$
\end{itemize}

Define $\delta_{ij}$ to be the proportion of persons who are infectious in spatial unit $s_i$ 
at time $t_j$. Then, letting $Inf(s_i, t_j)$ denote the event that a person becomes 
infected from contact within spatial unit $s_i$ at time $t_j$, we can derive:

\begin{center}

    $P(Inf(.,t_j)) = 1 - P(!Inf(s_i, t_j)) \cdot  P(!Inf(s_{-i}, t_j))$ \mbreak
    where \mbreak 
    $P(!Inf(s_i, t_j)) = E(!Inf(s_i, t_j)) = E(E(!Inf(s_i, t_j)|K_i=k_i))$  \mbreak 
    $\displaystyle =E(((1-\delta_{ij})q)^{k_i})$  \mbreak 
    $\displaystyle = \sum_{k=0}^{\infty} ((1-\delta_{ij})q)^k(\frac{\lambda_i^ke^{-\lambda_i}}{k!})$\mbreak
    $\displaystyle =  \sum_{k=0}^{\infty} q_{ij}^k (\frac{\lambda_i^ke^{-\lambda_i}}{k!})$\mbreak
    $\displaystyle = \frac{e^{-\lambda_i}}{e^{-q_{ij}\lambda_i}}(1)$
    $ = e^{-\lambda_i\cdot(1-q_{ij})} $
    $ = e^{-\lambda_i \cdot p_{ij}} $
    $ = e^{-\lambda_i \cdot (\delta_{ij}p)}$ \mbreak
    Therefore,  $P(Inf(s_i, t_j)) = 1 - e^{-\lambda_i \cdot (\delta_{ij}p)} $ \mbreak
    Similarly,\mbreak
    $\displaystyle P(!Inf(s_{-i}, t_j)) = \prod_{\left\{l \ne i\right\}}\left[P(!Inf(s_l, t_j)) \right]$ \mbreak
    $\displaystyle = \prod_{\left\{ l \ne i \right\}}\left[E(!Inf(s_{-i}, t_j))\right] $
    $\displaystyle = \prod_{\left\{ l \ne i \right\}}\left[E(E(!Inf(s_{-i}, t_j)|K_i=k_i)) \right]$  \mbreak 
    $\displaystyle = \prod_{\left\{ l \ne i \right\}}\left[ E((1-\delta_{lj})q)^k )  \right]$\mbreak 
    $\displaystyle = \prod_{\left\{ l \ne i \right\}}\left[ \sum_{k=0}^{\infty}(q_{lj}(i))^k\frac{(\lambda_l\cdot f(d_{il}))^ke^{-\lambda_l \cdot f(d_{il})}}{k!}    \right] $
    $\displaystyle = \prod_{\left\{ l \ne i \right\}}\left[ \frac{e^{-\lambda_l \cdot f(d_{il})}}{e^{-q_{lj}\lambda_l f(d_{il})}}(1)  \right]$\mbreak
    $\displaystyle = \prod_{\left\{ l \ne i \right\}}\left[ e^{-\lambda_l \cdot f(d_{il}) p_{lj}}  \right]$
    $\displaystyle = \prod_{\left\{ l \ne i \right\}}\left[ e^{-\lambda_l\cdot f(d_{il}) \cdot (\delta_{lj}p) }  \right]$\mbreak
    $\displaystyle = exp\left\{\sum_{\left\{ l \ne i \right\}}\left[p\lambda_l\delta_{jl}f(d_{il})   \right] \right\}$ \mbreak
    Thus, for the probabilty of infection for a person living in $s_i$ at time $t_j$ we have: \mbreak 
    $\displaystyle 1-\left(e^{-\lambda_i \cdot (\delta_{ij}p)}\right) \left( 
        e^{\left\{\sum_{\left\{ l \ne i \right\}}\left[p\lambda_l\delta_{jl}f(d_{il})   \right] \right\}}\right)
     $ \mbreak 

    $\displaystyle = 1- exp\left\{-\delta_{ij}e^{\theta_{i}} - \sum_{\left\{ l \ne i  \right\}}
        (f(d_{il})\delta_{il}e^{\theta_{l}})   \right\}$ 
    , where $\theta_{v} = log(\lambda_{v}p)$
 
\end{center}

Notes: 
\begin{enumerate}
    \item By defining $f(d_{ii})$ to be equal to $1$ for all $i$, the above expression has a simple 
        matrix form. 
    \item WLOG, we can make the mixing parameters dependent on space and time, defining $\lambda_{v_1, v_2}$,
        and correspondingly $\theta_{v_1,v_2}$
    \item When constructing full conditional distributions, it is important to keep in mind the constraint:
        $S+E+I+R=N$, as well as the fact that $p_{i,j}^{(SE)}$ does, in fact, depend on the value of $I$.
        This is easy to neglect and hard to debug. 

\end{enumerate}
\subsection{Re-infection Process}


To model the $\pi_j^{RS}$, some structure of lower than $T$ dimensions is desireable to reduce potential 
identifiability issues. A covariate structure constructed to capture natural variation in this quantity 
(seasonal polynomial components for example) will do nicely. Let $X(\pi_j^{RS})$ and $\beta_{\pi^{RS}}$ 
denote the covariate vector and corresponding regression parameter estimates 
for the j'th R to S transition probability respectively. Any number of link functions would be appropriate here.
 
\begin{enumerate}
    \item (Complimentary) Log Link \\
    $log(\pi_j^{RS}) = -X(\pi_j^{RS}) \beta_{\pi^{RS}}$
    \item Complimentary Log-Log Link \\
    $log(-log(\pi_j^{RS})) = X(\pi_j^{RS}) \beta_{\pi^{RS}}$
    \item Logit Link \\
    $log(\frac{\pi_j^{RS}}{1-\pi_j^{RS}}) = X(\pi_j^{RS}) \beta_{\pi^{RS}}$
\end{enumerate}

For simplicity, and to parallel the covariate scale used for $\left\{\pi_{ij}^{SE} \right\}$, lets 
use the log link (or rather, complimentary log link to keep the parameter sign easily interpretable).

\section{Basic Reproductive Number}

Using the next generation matrix approach to $\mathcal{R}_0$ calculation, we first define the matrix $G$ such 
that $G_{i,l}(t_j)$ is the expected number of infections in spatial location $s_i$ caused by a single infected
individual in location $s_l$ at time $t_j$.


Defining the relevant infection event for a person indexed by $k$ to be: $I_k(s_i, s_l, t_j)$, we see that the expected number of such
infections is:

\begin{center}
    $\displaystyle E\big[ \sum_{k=0}^{N_{i,j}}(I_k(s_i, s_l, t_j)) \big]$ \mbreak
    $\displaystyle = \sum_{k=0}^{N_{i,j}}\cdot P(I_k(s_i, s_l, t_j)) = N_{i,j}\cdot P(I_k(s_i, s_l, t_j)) $ \mbreak 
    Where, as before: \mbreak
    $ P(I_k(s_i, s_l, t_j)) = 1-exp\left\{-f(d_{il})\delta_{lj}e^{\theta_{l}} \right\}$ \mbreak
    This gives: \mbreak
    $G_{i,l}(t_j) = \frac{N_{i,j}}{I_{l,j}}\cdot \left[1-exp\left\{-f(d_{il})\delta_{lj}e^{\theta_{l}} \right\}\right]$ \mbreak
    Additionally recall the diagonal case, where $d_{ii} = 0$ and $f(0) = 1$:\mbreak 
    $G_{i,i}(t_j) = \frac{N_{i,j}}{I_{i,j}}\cdot \left[1-exp\left\{-\delta_{ij}e^{\theta_{i}} \right\}\right]$ \mbreak
    $ = \delta_{ij}^{-1}\cdot \left[1-exp\left\{-\delta_{ij}e^{\theta_{i}} \right\}\right]$ \mbreak


\end{center}

With this matrix constructed, the basic reproductive number can be immediately calculated as the dominant eigenvalue. 


\section{Posterior Distribution and Full Conditionals}

\subsection{Posterior Distribution}
\subsubsection{Summary of Distribution Components}
$\{S_{ij}^*\} \sim\  binom(R_{ij}, \pi_j^{(RS)})$\mbreak
$\{E_{ij}^*\} \sim binom(S_{ij}, \pi^{SE}_{ij})$ \mbreak
$\{I_{ij}^*\} \sim\  binom(E_{ij}, \pi^{(EI)})$\mbreak
$\{R_{ij}^*\} \sim\  binom(I_{ij}, \pi^{(IR)})$\mbreak
\noi
$\left\{\pi_{IR}  \right\} \sim\ beta(0.5, 0.5)$\mbreak 
$\left\{\pi^{EI}  \right\} \sim beta(0.5, 0.5)$\mbreak 
%%$\left\{\pi_j^{IR}  \right\} \sim beta(0.5, 0.5)$\mbreak 
$\left\{ \theta_{ij}\right\} \sim \mathcal{N}(\eta_{ij}, \sigma^2_{\theta})$ \mbreak
$\left\{ \beta \right\} \sim \mathcal{N}(0, \tau^2_\beta) $\mbreak 
$\left\{ \beta_{\pi^{RS}} \right\} \sim \mathcal{N}(0, \tau^2_{RS}) $\mbreak 
$\sigma^2_{\theta} \sim \Gamma(\alpha_\theta, \beta_\theta)$\mbreak
$\gamma_j \sim \Gamma(\alpha_\gamma, \beta_\gamma)$\mbreak
$\rho \sim U(0,1)$

\subsubsection{Deterministic Functions}
$S = f_S(S_0, E^*_0, S^*_0, S^*, E^*)$ \mbreak
$E = f_E(E_0, I^*_0, E^*_0, E^*, I^*)$ \mbreak
$I = f_I(I_0, R^*_0, I^*_0, I^*, R^*)$ \mbreak
$R = f_R(R_0, S^*_0, R^*_0, R^*, S^*)$ \mbreak
$\displaystyle log(\pi^{(SE)}_{ij}) = -\gamma_j-\delta_{ij}e^{\theta_{ij}} - \sum_{\left\{ l \ne i \right\}}d_{il}\delta_{il}e^{\theta_{il}}$\mbreak
$log(\pi_j^{RS}) = -X(\pi_j^{RS}) \beta_{\pi^{RS}}$\mbreak
$d_{il} = f(\rho, s_i, s_l)$\mbreak
$\delta_{ij} = \frac{I_{ij}}{N_{ij}}$ \mbreak
$\eta_{ij} = X_{ij}\beta$
\subsubsection{Posterior Distribution}

\begin{center}
\begin{multline}
\displaystyle
log(p(\theta,\beta,\rho,S^*,E^*,R^*|.)) \propto \Bigg[ 
    \sum_{i=1}^n \bigg\{ \sum_{j=1}^T
        \Big\{
            (S^*_{ij}log(\pi_j^{(RS)}) + (R_{ij} - S^*_{ij})log(1-\pi_j^{(RS)})) \\
            + (E^*_{ij}log(\pi_{ij}^{(SE)})) + (S_{ij} - E^*_{ij})log(1-\pi_{ij}^{(SE)}) \\
            + (I^*_{ij}log(\pi^{(EI)})) + (E_{ij} - I^*_{ij})log(1-\pi^{(EI)}) \\
            + (R^*_{ij}log(\pi^{(IR)})) + (I_{ij} - R^*_{ij})log(1-\pi^{(IR)}) \\
    - \frac{1}{2}log(\sigma^2_{\theta}) - \frac{(\theta_{ij}-\eta_{ij})^2}{2\sigma^2_{\theta}}\Big\}\bigg\} \\
    + \sum_{k = 1}^K\bigg\{-\frac{\beta^2_k}{10}\bigg\}
            + (log(\pi(\sigma^2_{\theta})))
            + (log(\pi(\rho)))\\
            + \bigg\{ -\frac{\tau^2_{RS}}{2}\|\beta_{\pi_j^{RS}}\|  \bigg\} \\ 
            + (\frac{1}{2}log(\pi^{(EI)}) + \frac{1}{2}log(1-\pi^{(EI)})) \\
            + (\frac{1}{2}log(\pi^{(IR)}) + \frac{1}{2}log(1-\pi^{(IR)}))    \\
            + \sum_{j=1}^{T} \bigg\{ log(\pi(\gamma_j)) \bigg\} \Bigg]\\
\end{multline}
\end{center}

For simplicity, and because the model is sufficiently flexible without the added over-dispersion, set $\theta_{ij} = \eta_{ij}$ with probability 1. This 
gives the following simplified posterior distribution:

\begin{center}
\begin{multline}
\displaystyle
log(p(\theta,\beta,\rho,S^*,E^*,R^*|.)) \propto \\
\Bigg[ \sum_{i=1}^n \bigg\{ \sum_{j=1}^T
        \Big\{
            log\bigg(\dbinom{R_{ij}}{S^*_{ij}}\bigg) + (S^*_{ij}log(\pi_j^{(RS)}) + (R_{ij} - S^*_{ij})log(1-\pi_j^{(RS)})) \\
            + log\bigg(\dbinom{S_{ij}}{E^*_{ij}}\bigg) + (E^*_{ij}log(\pi_{ij}^{(SE)})) + (S_{ij} - E^*_{ij})log(1-\pi_{ij}^{(SE)}) \\
            + log\bigg(\dbinom{E_{ij}}{I^*_{ij}}\bigg) + (I^*_{ij}log(\pi^{(EI)})) + (E_{ij} - I^*_{ij})log(1-\pi^{(EI)}) \\
            + (log\bigg(\dbinom{I_{ij}}{R^*_{ij}}\bigg) + R^*_{ij}log(\pi^{(IR)})) + (I_{ij} - R^*_{ij})log(1-\pi^{(IR)}) \Big\}\bigg\} \\
    + \sum_{k = 1}^K\bigg\{-\frac{\beta^2_k}{10}\bigg\}
            + (log(\pi(\rho)))\\
            +  \bigg\{ -\frac{\tau^2_{RS}}{2}\|\beta_{\pi_j^{RS}}\|  \bigg\} \\ 
            + (\frac{1}{2}log(\pi^{(EI)}) + \frac{1}{2}log(1-\pi^{(EI)})) \\
            + (\frac{1}{2}log(\pi^{(IR)}) + \frac{1}{2}log(1-\pi^{(IR)})) \\
            + \sum_{j=1}^{T} \bigg\{ log(\pi(\gamma_j)) \bigg\}\Bigg]\\
\end{multline}
\end{center}

Now define the fixed set $A_0 = \{S_0, E_0, I_0, R_0, S^*_0, E^*_0, I^*_0, R^*_0\}$,
and reparameterize $S, E, I, R$ as explicit functions of the transition matrices. 


\begin{center}
\begin{multline}
\displaystyle
log(p(\theta,\beta,\rho,S^*,E^*,R^*|.)) \propto\\ \Bigg[ 
            %% S Piece
    \sum_{j=1}^T \sum_{i=1}^n\Big\{log\bigg(\dbinom{R_{ij}}{S^*_{ij}}\bigg) + log(\pi_j^{(RS)})\{S^*_{ij}\} + 
            log(1-\pi_j^{(RS)})\{f_R(R^*, S^*, A_0)_{ij} - S^*_{ij}\}\Big\} \\ 
            %% E Piece
            +\sum_{i=1}^n \sum_{j=1}^T\bigg\{
            log\bigg(\dbinom{S_{ij}}{E^*_{ij}}\bigg) + (E^*_{ij}log(\pi_{ij}^{(SE)})) + (f_S(S^*, E^*, A_0)_{ij} - E^*_{ij})log(1-\pi_{ij}^{(SE)})\bigg\} \\
            %% I Piece
            + \sum_{i=1}^n\sum_{j=1}^T\bigg\{ log\bigg(\dbinom{E_{ij}}{I^*_{ij}}\bigg)\bigg\} + log(\pi^{(EI)})\sum_{i=1}^n\sum_{j=1}^T\{I^*_{ij}\} 
            + log(1-\pi^{(EI)})\sum_{i=1}^n\sum_{j=1}^T\{(f_E(E^*, I^*, A_0)_{ij} - I^*_{ij})\}\\
            %% R Piece
            + \sum_{i=1}^n\sum_{j=1}^T\bigg\{ log\bigg(\dbinom{I_{ij}}{R^*_{ij}}\bigg)\bigg\} + log(\pi^{(IR)})\sum_{i=1}^n\sum_{j=1}^T\{R^*_{ij}\} + 
            log(1-\pi^{IR})\sum_{i=1}^n\sum_{j=1}^T\{ f_I(I^*, R^*, A_0)_{ij} - R^*_{ij}\}\\
            %% Beta
            + \sum_{k = 1}^K\bigg\{-\frac{\beta^2_k}{10}\bigg\}
            %% Rho prior
            + (log(\pi(\rho)))\\
            %% \beta_{\pi_j^{RS}}
            + \bigg\{ -\frac{\tau^2_{RS}}{2}\|\beta_{\pi_j^{RS}}\|  \bigg\} \\ 
            %% \pi^{EI}
            + (\frac{1}{2}log(\pi^{(EI)} + \frac{1}{2}log(1-\pi^{(EI)}))) \\
            %% \pi^{IR}
            + (\frac{1}{2}log(\pi^{(IR)} + \frac{1}{2}log(1-\pi^{(IR)})))   
            %% Gamma
            + \sum_{j=1}^{T} \bigg\{ log(\pi(\gamma_j)) \bigg\}\Bigg]\\
\end{multline}
\end{center}


\subsection{Full Conditional Distributions}
Depending on when the disease of interest is expected to be detected, the data can be 
introduced as the $E^*$ exposure counts, or as the $I^*$ infection counts. Other latent 
processes could also be introduced. For this reason, full conditional distributions are 
introduced for all categories. 

{\bf{TO DO: Modify full conditionals to reflect additional compartment dependence on star matrices.}}

\begin{itemize}
    \item{Full Conditional For $S^*$}
%\subsubsection{$p(S^*|.)$}
    \begin{center}
        \begin{multline}
        \displaystyle
        log(p(S^*|.))\propto 
            \sum_{j=1}^T\sum_{i=1}^n\Big\{log\bigg(\dbinom{R_{ij}}{S^*_{ij}}\bigg) + log(\pi_j^{(RS)})\{S^*_{ij}\} + 
                log(1-\pi_j^{(RS)})\{f_R(R^*, S^*, A_0)_{ij} - S^*_{ij}\}\\ 
            + log\bigg(\dbinom{S_{ij}}{E^*_{ij}}\bigg) + f_S(S^*, E^*, A_0)_{ij}log(1-\pi_{ij}^{(SE)})\Big\}
        \end{multline}
    \end{center}

    \item{Full Conditional for $E^*$}
%\subsubsection{$p(E^*|.)$}
    \begin{center}
    \begin{multline}
        \displaystyle
        log(p(E^*|.))\propto \sum_{i=1}^n \sum_{j=1}^T\bigg\{log\bigg(\dbinom{S_{ij}}{E^*_{ij}}\bigg) + 
                (E^*_{ij}log(\pi_{ij}^{(SE)})) + (f_S(S^*, E^*, A_0)_{ij} - E^*_{ij})log(1-\pi_{ij}^{(SE)})\bigg\} \\
                + log\bigg(\dbinom{E_{ij}}{I^*_{ij}}\bigg) + log(1-\pi^{(EI)})\sum_{i=1}^n\sum_{j=1}^T\{(f_E(E^*, I^*, A_0)_{ij}\}\\
    \end{multline}
    \end{center}

    \item{Full Conditional for $I^*$}
%\subsubsection{$p(I^*|.)$}
    \begin{center}
    \begin{multline}
        \displaystyle
        log(p(I^*|.)) \propto \sum_{i=1}^n\sum_{j=1}^T\bigg\{ log\bigg(\dbinom{E_{ij}}{I^*_{ij}}\bigg) + log(\pi^{(EI)})\{I^*_{ij}\}          
            + log(1-\pi^{(EI)})\{(f_E(E^*, I^*, A_0)_{ij} - I^*_{ij})\}\\
            + log\bigg(\dbinom{I_{ij}}{R^*_{ij}}\bigg) + log(1-\pi^{IR})\{ f_I(I^*, R^*, A_0)_{ij}\}\bigg\}\\
    \end{multline}
    \end{center}

    \item{Full Conditional for $R^*$}
%\subsubsection{$p(R^*|.)$}
    \begin{center}
    \begin{multline}
        \displaystyle
        log(p(R^*|.)) \propto \sum_{i=1}^n\sum_{j=1}^T\bigg\{log\bigg(\dbinom{I_{ij}}{R^*_{ij}}\bigg) + log(\pi^{(IR)})\{R^*_{ij}\}
            + log(1-\pi^{IR})\{f_I(I^*, R^*, A_0)_{ij} - R^*_{ij}\}\\
            + log\bigg(\dbinom{R_{ij}}{S^*_{ij}}\bigg) + log(1-\pi_j^{(RS)})\{f_R(R^*, S^*, A_0)_{ij}\}\bigg\}\\ 
    \end{multline}
    \end{center}
    \item{Full Conditional for $\{\theta\}$}
%\subsubsection{$p(\{\theta\})|.)$}
    \begin{center}
    \begin{multline}
        \displaystyle
        log(p(\{\theta\}|.)) \propto \sum_{i=1}^n \bigg\{ \sum_{j=1}^T\Big\{
            (E^*_{ij}log(\pi_{ij}^{(SE)})) + (f_S(S^*, E^*, A_0)_{ij} - E^*_{ij})log(1-\pi_{ij}^{(SE)})\Big\}\bigg\} \\
    \end{multline}
    \end{center}

    \item{Full Conditional for $\{\beta\}$}
%\subsubsection{$p(\{\beta\}|.)$}
    \begin{center}
    \begin{multline}
        \displaystyle
        log(p(\{\beta\}|.)) \propto
            \sum_{i=1}^n \bigg\{ \sum_{j=1}^T\Big\{
            (E^*_{ij}log(\pi_{ij}^{(SE)})) + (f_S(S^*, E^*, A_0)_{ij} - E^*_{ij})log(1-\pi_{ij}^{(SE)})\Big\}\bigg\} \\
             + \sum_{k = 1}^K\bigg\{-\frac{\beta^2_k}{10}\bigg\}
    \end{multline}
    \end{center}
%\subsubsection{$p(\rho|.)$}

    \item{Full Conditional for $\rho$}
    \begin{center}
    \begin{multline}
        \displaystyle
        log(p(\rho|.)) \propto\sum_{i=1}^n \bigg\{ \sum_{j=1}^T\Big\{
            (E^*_{ij}log(\pi_{ij}^{(SE)})) + (f_S(S^*, E^*, A_0)_{ij} - E^*_{ij})log(1-\pi_{ij}^{(SE)})\Big\}\bigg\} \\
            + (log(\pi(\rho)))\\
    \end{multline}
    \end{center}

    \item{Full Conditional for $\gamma_j$}
    \begin{center}
    \begin{multline}
        \displaystyle
        log(p(\rho|.)) \propto\sum_{i=1}^n \bigg\{ \sum_{j=1}^T\Big\{
            (E^*_{ij}log(\pi_{ij}^{(SE)})) + (f_S(S^*, E^*, A_0)_{ij} - E^*_{ij})log(1-\pi_{ij}^{(SE)})\Big\}\bigg\} \\
            + (\sum_{j=1}^{T}log(\pi(\gamma_j)))\\
    \end{multline}
    \end{center}


\item{Full Conditional for $\{\beta_{\pi_{j}^{(RS)}}\}$}
    \begin{center}
    \begin{multline}
        \displaystyle
        log(p(\{\pi_{j}^{(RS)}\}|.))\propto\sum_{j=1}^T\Big\{log(\pi_j^{(RS)})\Big[\sum_{i=1}^n\{S^*_{ij}\}\Big] \\
            \ \ \ \ + 
            log(1-\pi_j^{(RS)})\Big[\sum_{i=1}^n\{f_R(R^*, S^*, A_0)_{ij} - S^*_{ij}\}\Big]\Big\}\\ 
            + \bigg\{ -\frac{\tau^2_{RS}}{2}\|\beta_{\pi_j^{RS}}\|  \bigg\} \\ 
    \end{multline}
\end{center}

\item{Full Conditional for $\pi^{(EI)}$} 
    \begin{center}
        \begin{multline}
            \displaystyle
            log(p(\pi^{(EI)})) \propto log(\pi^{(EI)})\Big[\frac{1}{2} + \sum_{i=1}^n\sum_{j=1}^T\{I^*_{ij}\}\Big] 
            \\+ log(1-\pi^{(EI)})\Big[\frac{1}{2} + \sum_{i=1}^n\sum_{j=1}^T\{(f_E(E^*, I^*, A_0)_{ij} - I^*_{ij})\}\Big]\\
            \Rightarrow \pi^{(EI)} \sim beta(\frac{3}{2} + \sum_{j=1}^T\sum_{i=1}^n\{I^*_{ij}\}, 
            \frac{3}{2} + \sum_{j=1}^T\sum_{i=1}^n\{f_E(E^*, I^*, A_0)_{ij}\} - \sum_{j=1}^T\sum_{i=1}^n\{I^*_{ij}\}) 
        \end{multline}
    \end{center}
\item{Full Conditional for $\pi^{(IR)}$} 
    \begin{center}
        \begin{multline}
            \displaystyle
            log(p(\pi^{(IR)})) \propto log(\pi^{(IR)})\Big[\frac{1}{2} + \sum_{i=1}^n\sum_{j=1}^T\{R^*_{ij}\}\Big] + 
            log(1-\pi^{(IR)})\Big[\frac{1}{2} + \sum_{i=1}^n\sum_{j=1}^T\{ f_I(I^*, R^*, A_0)_{ij} - R^*_{ij}\}\Big]\\
            \Rightarrow \pi^{(IR)} \sim beta(\frac{3}{2} + \sum_{j=1}^T\sum_{i=1}^n\{R^*_{ij}\}, 
            \frac{3}{2} + \sum_{j=1}^T\sum_{i=1}^n\{f_I(I^*, R^*, A_0)_{ij}\} - \sum_{j=1}^T\sum_{i=1}^n\{R^*_{ij}\})
        \end{multline}
    \end{center}




\end{itemize}


\section{Notes}

\subsection{Random Variate Generation}

The gamma distribution is parameterized by boost as:
$\displaystyle p(x) = x^{\alpha-1}\frac{e^{-x/\beta}}{\beta^\alpha\Gamma(\alpha)}$

\end{document}
